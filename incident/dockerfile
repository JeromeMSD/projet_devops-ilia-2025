# On utilise une image Python légère
FROM python:3.11-slim AS builder

# On définit le répertoire de travail
WORKDIR /tmp

# On copie le fichier de dépendances
COPY requirements.txt requirements.txt

# On installe les dépendances
RUN pip install --no-cache-dir -r requirements.txt

# On utilise la même base Python légère pour l'image finale
FROM python:3.11-slim AS runtime

# On définit le répertoire de travail pour l'application finale
WORKDIR /app

# Création et utilisation d'un utilisateur non-root
RUN groupadd -r appgroup && useradd -r -g appgroup -u 1000 appuser
USER appuser

# On copie les dépendances installées depuis l'étape builder
COPY --from=builder /usr/local/lib/python3.11/site-packages /usr/local/lib/python3.11/site-packages

# On copie le code source et les fichiers de configuration nécessaires au runtime
COPY src/ ./src/
COPY swagger.yaml .

# On expose le port utilisé par le serveur Flask
EXPOSE 5000

# On définit la commande de démarrage du microservice Flask
CMD ["python", "src/main.py"]