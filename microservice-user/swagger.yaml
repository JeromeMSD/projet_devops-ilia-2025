openapi: 3.0.0
info:
  title: User Microservice API
  version: 1.1.0
  description: |
    Microservice de gestion des utilisateurs, de l'authentification et des rôles.  
    Ce service agit comme **API d'authentification centrale (Auth Gateway)** pour les autres microservices.
    - Gère l'inscription (`/register`), la connexion (`/login`), la vérification du token (`/verify-token`)
    - Stocke les utilisateurs et leurs sessions dans Redis
    - Fournit un système de rôles (`USER`, `SRE`, `ADMIN`)
servers:
  - url: http://localhost:5010
    description: Serveur local de développement

tags:
  - name: Authentication
    description: Gestion de l'authentification et des tokens JWT
  - name: Users
    description: Gestion des utilisateurs (consultation, création, filtre par rôle)
  - name: Gateway
    description: Vérification des tokens par les autres microservices
  - name: Password
    description: Gestion du changement de mot de passe

paths:
  /api/v1/register:
    post:
      tags: [Users]
      summary: Inscription d'un nouvel utilisateur
      description: |
        Crée un nouvel utilisateur avec un rôle défini (`USER`, `SRE`, `ADMIN`).
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [firstname, lastname, email, password, role]
              properties:
                firstname:
                  type: string
                  example: Simon
                lastname:
                  type: string
                  example: Pierre
                email:
                  type: string
                  format: email
                  example: simon.pierre@example.com
                password:
                  type: string
                  format: password
                  example: Password123
                role:
                  type: string
                  enum: [USER, SRE, ADMIN]
                  example: USER
      responses:
        '201':
          description: Utilisateur créé avec succès
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Utilisateur créé avec succès.
                  user:
                    $ref: '#/components/schemas/User'
        '400':
          description: Données invalides ou champs manquants
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Champs manquants ou donnees invalides
        '409':
          description: Conflit - Email déjà enregistré
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Un email avec cet email existe deja.
        '500':
          description: Erreur interne lors de la création
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Erreur interne du serveur

  /api/v1/login:
    post:
      tags: [Authentication]
      summary: Connexion d'un utilisateur
      description: |
        Authentifie un utilisateur avec son email et son mot de passe.  
        Retourne un **JWT Token** et les informations utilisateur.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email:
                  type: string
                  format: email
                  example: simon.pierre@example.com
                password:
                  type: string
                  format: password
                  example: Password123
      responses:
        '200':
          description: Connexion réussie
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Successfully logged in!
                  user:
                    $ref: '#/components/schemas/User'
        '400':
          description: Corps de requête invalide ou champs manquants
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Champs manquants ou champs malformés
        '401':
          description: Mot de passe incorrect
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Mot de passe incorrect
        '404':
          description: Utilisateur inexistant
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Utilisateur inexistant en base de donnees
        '500':
          description: Erreur interne du serveur

  /api/v1/verify-token:
    get:
      tags: [Gateway]
      summary: Vérifie la validité d'un token JWT
      description: |
        Vérifie un **token JWT** envoyé dans le header `Authorization: Bearer <token>`.  
        - Valide la signature, l'expiration et la présence dans Redis.  
        - Utilisé par les **autres microservices** pour valider un utilisateur.
        - Utilisé par le frontend pour obtenir l'utilisateur connectée.
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Token valide, session active
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Utilisateur connecté
                  user:
                    $ref: '#/components/schemas/User'
        '403':
          description: Token manquant, expiré ou invalide
        '500':
          description: Erreur interne du serveur

  /api/v1/logout:
    post:
      tags: [Authentication]
      summary: Déconnexion d'un utilisateur
      description: |
        Déconnecte l'utilisateur en révoquant son token JWT dans Redis.  
        Le token devient immédiatement inutilisable, même s'il n'est pas expiré.
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Déconnexion réussie
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Utilisateur déconnecté avec succès
        '403':
          description: Token manquant, expiré, invalide ou déjà révoqué
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Token révoqué
        '500':
          description: Erreur interne du serveur
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Une erreur inattendue est survenue lors de la déconnexion

  # SUPPRIMER la route orpheline qui commence à la ligne 128 et l'ancienne route /api/v1/users/role/{role}

  /api/v1/users/{user_id}:
    put:
      tags: [Users]
      summary: Modifie un utilisateur
      description: |
        Modifie les informations d'un utilisateur.  
        ⚠️ Accessible uniquement aux rôles `ADMIN` ou `SRE`.
      security:
        - bearerAuth: []
      parameters:
        - name: user_id
          in: path
          required: true
          description: ID de l'utilisateur à modifier
          schema:
            type: string
            example: 4fa3a1c2-84ad-42b8-8123-1234abcd5678
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                firstname:
                  type: string
                  example: NouveauPrénom
                lastname:
                  type: string
                  example: NouveauNom
                role:
                  type: string
                  enum: [USER, SRE, ADMIN]
                  example: ADMIN
      responses:
        '200':
          description: Utilisateur modifié avec succès
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Utilisateur modifié avec succès
                  user:
                    $ref: '#/components/schemas/User'
        '400':
          description: Données invalides
        '403':
          description: Accès refusé
        '404':
          description: Utilisateur non trouvé
        '500':
          description: Erreur interne du serveur

  /api/v1/forgot-password:
    post:
      tags: [Password]
      summary: Demande de réinitialisation de mot de passe
      description: |
        Génère un token de réinitialisation de mot de passe valable 30 minutes.  
        ⚠️ Pour des raisons de sécurité (OWASP), retourne toujours 200 même si l'email n'existe pas.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email]
              properties:
                email:
                  type: string
                  format: email
                  example: utilisateur@example.com
      responses:
        '200':
          description: Token généré avec succès (même si email inexistant)
          content:
            application/json:
              schema:
                oneOf:
                  - type: object
                    properties:
                      message:
                        type: string
                        example: Si cet email existe, un lien de réinitialisation a été envoyé
                  - type: object
                    properties:
                      message:
                        type: string
                        example: Token de réinitialisation généré avec succès
                      reset_token:
                        type: string
                        description: Token JWT de réinitialisation (valable 30 minutes)
                        example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        '400':
          description: Email manquant ou format invalide
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Format d'email invalide
        '500':
          description: Erreur interne du serveur

  /api/v1/reset-password:
    post:
      tags: [Password]
      summary: Réinitialisation du mot de passe
      description: |
        Réinitialise le mot de passe avec un token de reset.  
        Le token est à usage unique et expire après 30 minutes.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [reset_token, new_password]
              properties:
                reset_token:
                  type: string
                  description: Token reçu via /forgot-password
                  example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                new_password:
                  type: string
                  format: password
                  description: |
                    Nouveau mot de passe (min 6 caractères, 1 majuscule, 1 minuscule, 1 chiffre)
                  example: NouveauPassword123
      responses:
        '200':
          description: Mot de passe réinitialisé avec succès
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Mot de passe réinitialisé avec succès
        '400':
          description: Champs manquants ou mot de passe invalide
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Le mot de passe doit contenir au moins 6 caractères, une majuscule, une minuscule et un chiffre
        '403':
          description: Token invalide, expiré ou déjà utilisé
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Token de réinitialisation invalide ou expiré
        '500':
          description: Erreur interne du serveur

  /api/v1/users:
    get:
      tags: [Users]
      summary: Récupère tous les utilisateurs (avec filtrage optionnel par rôle)
      description: |
        Retourne la liste des utilisateurs.  
        - Sans paramètre : retourne **tous** les utilisateurs  
        - Avec `?role=ROLE` : filtre par rôle spécifique  
        ⚠️ Accessible uniquement aux rôles `ADMIN` ou `SRE`.
      security:
        - bearerAuth: []
      parameters:
        - name: role
          in: query
          required: false
          description: |
            Filtre optionnel par rôle.  
            Insensible à la casse (admin = ADMIN = Admin).
          schema:
            type: string
            enum: [USER, SRE, ADMIN]
            example: ADMIN
      responses:
        '200':
          description: Liste des utilisateurs (filtrés ou tous)
          content:
            application/json:
              schema:
                type: object
                properties:
                  count:
                    type: integer
                    example: 3
                  users:
                    type: array
                    items:
                      $ref: '#/components/schemas/User'
<<<<<<< HEAD
        '401':
          description: Unauthorized - token missing or invalid

  /api/v1/auth/login:
    post:
      tags:
        - Authentication
      summary: Login user
      description: Authenticate user and receive JWT token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - password
              properties:
                username:
                  type: string
                  example: john_doe
                password:
                  type: string
                  format: password
                  example: securePassword123
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Login successful
                  token:
                    type: string
                    example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                  user:
                    $ref: '#/components/schemas/User'
        '401':
          description: Invalid credentials

  /api/v1/users/{user_id}:
    get:
      tags:
        paths:
  /users/{user_id}:
    get:
      summary: Get user by ID
      description: Retrieve user details by user ID (requires authentication)
      tags:
        - Users
      security:
        - bearerAuth: []  
      parameters:
        - name: user_id
          in: path
          required: true
          description: The unique identifier of the user
          schema:
            type: string
          example: USR-1699876543
      responses:
        '200':
          description: User details successfully retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          description: Unauthorized - invalid or missing token
        '404':
          description: User not found

    put:
      tags:
        - Users
      summary: Update user
      description: Update user details (users can update their own info, admins can update any user)
      security:
        - bearerAuth: []
      parameters:
        - name: user_id
          in: path
          required: true
          schema:
            type: string
          example: USR-1699876543
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
                  example: newemail@example.com
                password:
                  type: string
                  format: password
                  example: newPassword123
                role:
                  type: string
                  enum: [user, sre, admin]
                  example: sre
                  description: Only admins can change roles
      responses:
        '200':
          description: User updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: User updated successfully
                  user:
                    $ref: '#/components/schemas/User'
        '401':
          description: Unauthorized
=======
          examples:
            tous_les_utilisateurs:
              summary: Tous les utilisateurs
              value:
                count: 5
                users:
                  - id_user: "4fa3a1c2-84ad-42b8-8123-1234abcd5678"
                    firstname: "Simon"
                    lastname: "Pierre"
                    email: "simon.pierre@example.com"
                    role: "USER"
                    created_at: "2025-11-10T10:30:00Z"
                  - id_user: "5fb4b2d3-95be-53c9-9234-2345bcde6789"
                    firstname: "Admin"
                    lastname: "User"
                    email: "admin@example.com"
                    role: "ADMIN"
                    created_at: "2025-11-10T11:00:00Z"
            utilisateurs_filtres:
              summary: Utilisateurs filtrés par rôle
              value:
                count: 2
                users:
                  - id_user: "5fb4b2d3-95be-53c9-9234-2345bcde6789"
                    firstname: "Admin"
                    lastname: "User"
                    email: "admin@example.com"
                    role: "ADMIN"
                    created_at: "2025-11-10T11:00:00Z"
                  - id_user: "6gc5c3e4-a6cf-64da-0345-3456cdef7890"
                    firstname: "Super"
                    lastname: "Admin"
                    email: "super.admin@example.com"
                    role: "ADMIN"
                    created_at: "2025-11-10T12:00:00Z"
>>>>>>> origin/Microservice-USER
        '403':
          description: Accès refusé (token invalide ou permissions insuffisantes)
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Permission refusée, Vous devez être ['ADMIN', 'SRE']
        '500':
          description: Erreur interne du serveur
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Cannot connect to database

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    User:
      type: object
      description: Représentation d'un utilisateur du système
      properties:
        id_user:
          type: string
          example: 4fa3a1c2-84ad-42b8-8123-1234abcd5678
        firstname:
          type: string
          example: Simon
        lastname:
          type: string
          example: Pierre
        email:
          type: string
          format: email
          example: simon.pierre@example.com
        role:
          type: string
          enum: [USER, SRE, ADMIN]
          example: USER
        token:
          type: string
          description: JWT Token actif de l'utilisateur (vide si déconnecté)
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        created_at:
          type: string
          format: date-time
          example: 2025-11-10T10:30:00Z