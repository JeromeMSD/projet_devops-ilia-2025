name: CI Build - User Microservice

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'microservice-user/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'microservice-user/**'

jobs:
  build-and-test:
    name: Build & Test User Service
    runs-on: ubuntu-latest

    # Récupérer la clé secrète depuis GitHub pour l'injecter dans les tests et l'image
    env:
      # JWT_SECRET_KEY doit être configuré dans les secrets du dépôt
      JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}

       # User keys
      EMAIL_KEY: "email:"
      USER_KEY: "user:"

       # API configuration
      BASE_API_URL: /api/v1

       # Microservice configuration
      MICRO_SERVICE_HOST: 0.0.0.0
      MICRO_SERVICE_PORT: 5010

      # Redis configuration (override for Docker)
      REDIS_HOST_PYTEST: "localhost"
      REDIS_HOST_DOCKER: "redis-test"
      REDIS_PORT: 6379
      REDIS_DB_USERS: 0
      REDIS_TEST_DB: 1
      FLASK_TESTING: false

      # Flask configuration for docker
      FLASK_APP: src.main:create_app
      FLASK_ENV: development
      FLASK_DEBUG: True
      FLASK_RUN_PORT: 5010
      FLASK_RUN_HOST: 0.0.0.0



    steps:
      # 1. Récupérer le code
      - name: Checkout repository
        uses: actions/checkout@v4
        # Utiliser 'submodules: recursive' si le projet principal est un monorepo
        with:
          path: microservice-user

      # 2. Configuration Python
      - name: Set up Python 3.12
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      # 3. Cache pip
      - name: Cache pip packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('microservice-user/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # 4. Installer les dépendances
      - name: Install dependencies
        working-directory: ./microservice-user
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt


      # 5. Lancer Redis pour les tests (DB 1)
      - name: Start Redis and Docker Network
        run: |
          docker network create ci-network || true
          docker run -d  \
            --name redis-test\
            --network ci-network \
            -p ${{ env.REDIS_PORT }}:${{ env.REDIS_PORT }} \ 
            redis:7-alpine


      # 6. Lancer les tests Pytest
      - name: Run Pytest & Coverage
        working-directory: ./microservice-user
        env:
          FLASK_TESTING: "true"
          REDIS_HOST: ${{ env.REDIS_HOST_PYTEST }}
        run: python -m pytest -v -s --cov=src --cov-report=term-missing


      # 7. Build Docker image
      - name: Build Docker image
        working-directory: ./microservice-user
        run: docker build -t user-microservice:${{ github.sha }} .


      # 8. Test Sanitaire de l'Image Docker (Vérification du Démarrage)
      - name: Test Docker image Health Check
        run: |
          docker run -d \
            --name user-service-test \
            --network ci-network \
            -p 5010:${{ env.FLASK_RUN_PORT }} \
            \
            -e REDIS_PORT=${{ env.REDIS_PORT }} \
            -e REDIS_HOST=${{ env.REDIS_HOST_DOCKER }} \
            -e JWT_SECRET_KEY=${{ env.JWT_SECRET_KEY }} \
            -e BASE_API_URL=${{ env.BASE_API_URL }} \
            -e FLASK_APP=${{ env.FLASK_APP }} \
            -e FLASK_ENV=${{ env.FLASK_ENV }} \
            -e FLASK_DEBUG=${{ env.FLASK_DEBUG }} \
            -e FLASK_RUN_PORT=${{ env.FLASK_RUN_PORT }} \
            -e FLASK_RUN_HOST=${{ env.FLASK_RUN_HOST }} \
            -e EMAIL_KEY=${{ env.EMAIL_KEY }} \
            -e USER_KEY=${{ env.USER_KEY }} \
            \
            user-microservice:${{ github.sha }} 
          echo "Waiting for Flask server to start..."
          sleep 15
          
          # Vérifier que le service répond (localhost:5010 sur la VM hôte)
          echo "Testing /api/v1/users endpoint..."
          curl -f http://localhost:5010/api/v1/users || exit 1
          
          echo "✅ CI Build Success!"
